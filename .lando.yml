name: d9-quickstart
recipe: drupal9
env_file:
  - .env

config:
  xdebug: false
  webroot: docroot
  php: '7.4'
  composer_version: '2'

proxy:
  mailhog:
    - mailhog.d9-quickstart.lndo.site
  fe-node:
    - frontend.d9-quickstart.lndo.site
  phpmyadmin:
    - phpmyadmin.d9-quickstart.lndo.site

services:
  appserver:
    build:
      - composer install
      - "/app/vendor/bin/phpcs --config-set installed_paths /app/vendor/drupal/coder/coder_sniffer,/app/vendor/phpcompatibility/php-compatibility/PHPCompatibility"
    overrides:
      environment:
        DRUSH_OPTIONS_ROOT: '/app/docroot'
        DRUSH_OPTIONS_URI: 'https://d9-quickstart.lndo.site'

  database:
    creds:
      user: drupal
      password: drupal
      database: drupal
    overrides:
      volumes:
        - ./.mariadb-init:/docker-entrypoint-initdb.d # A starter database is inside here.

  mailhog:
    type: mailhog
    hogfrom:
      - appserver
    portforward: true

  redis:
    type: 'redis:4'

  fe-node:
    type: 'node:custom'
    app_mount: disabled
    overrides:
      image: deeson/fe-node:v12
      volumes:
        - ./src/frontend:/app:delegated
      working_dir: /app
      environment:
        DOCKER_LOCAL: 1
      command: bash -c 'yarn install && yarn start'

  fe-php:
    type: 'php:custom'
    app_mount: disabled
    overrides:
      image: deeson/fe-php
      depends_on:
        - 'fe-node'
      volumes:
        - ./src/frontend:/app:delegated
      working_dir: /app
      environment:
        DOCKER_LOCAL: 1
      command: bash -c 'composer install && node_modules/.bin/deeson-router-start'

  phpmyadmin:
    type: phpmyadmin

tooling:
  drush:
    service: appserver
    cmd: "/app/vendor/bin/drush --root=/app/docroot"

  lint:standards:
    service: appserver
    description: Run phpcs Drupal Coding Standards against modules and themes.
    cmd: "/app/vendor/bin/phpcs --standard=Drupal,DrupalPractice --extensions=php,inc,module,theme --exclude=Drupal.Commenting.DocComment,Drupal.Commenting.ClassComment --ignore=src/modules/entity_class_bundles_demo,src/themes/deeson_frontend_framework /app/src/modules/ /app/src/themes/"

  lint:deprecated:
    service: appserver
    description: Run phpstan deprecated checks against modules and themes.
    cmd: '/app/vendor/bin/phpstan analyse -c /app/phpstan.neon /app/src/modules/ /app/src/themes/'

  lint:php:
    service: appserver
    description: Run phpcs PHPCompatibility checks against a given file or directory.
    cmd: /app/vendor/bin/phpcs --standard=PHPCompatibility --extensions=php,inc,module,theme --runtime-set testVersion 7.4 --ignore=src/modules/entity_class_bundles_demo,src/themes/deeson_frontend_framework /app/src/modules/ /app/src/themes/

  xdebug:on:
    service: appserver
    description: Enable xdebug for apache.
    cmd: "docker-php-ext-enable xdebug && /etc/init.d/apache2 reload"
    user: root

  xdebug:off:
    service: appserver
    description: Disable xdebug for apache.
    cmd: "rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 reload"
    user: root

  node:
    service: fe-node

  npm:
    service: fe-node

  yarn:
    service: fe-node

  phpcs:
    service: appserver
    cmd: '/app/vendor/bin/phpcs'

  phpstan:
    service: appserver
    cmd: '/app/vendor/bin/phpstan'

